/*
 * This file was generated by the Gradle 'init' task.
 *
 * This project uses @Incubating APIs which are subject to change.
 */

plugins {
	id 'application'
	id 'io.spring.dependency-management' version '1.1.6'
	id 'org.springframework.boot' version '3.1.11'
	id 'com.github.ben-manes.versions' version '0.51.0'
	id 'org.owasp.dependencycheck' version '10.0.3'
	id 'org.sonarqube' version '5.1.0.4882'
	id 'checkstyle'
  id 'pmd'
  id 'war'
  id 'jacoco'
}

group = 'uk.gov.hmcts'
version = '1.0'
description = 'pdmanager'

java {
  toolchain {
    languageVersion = JavaLanguageVersion.of(17)
  }
}

sourceSets {

    smokeTest {
        java {
            compileClasspath += main.output
            runtimeClasspath += main.output
            srcDir file('src/smokeTest/java')
        }
        resources.srcDir file('src/smokeTest/resources')
    }

    functionalTest {
        java {
          compileClasspath += main.output
          runtimeClasspath += main.output
          srcDir file('src/functionalTest/java')
        }
        resources.srcDir file('src/functionalTest/resources')
    }
}

processSmokeTestResources {
  duplicatesStrategy = DuplicatesStrategy.EXCLUDE
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs << "-Xlint:unchecked" << "-Werror"
    
}

// https://github.com/gradle/gradle/issues/16791
tasks.withType(JavaExec).configureEach {
  javaLauncher.set(javaToolchains.launcherFor(java.toolchain))
}



tasks.withType(Javadoc) {
    options.encoding = 'UTF-8'
}


tasks.withType(Test) {
  useJUnitPlatform()

  testLogging {
    exceptionFormat = 'full'
    events "standardOut", "started", "passed", "skipped", "failed"
  }
}

test {
  failFast = true
}



// before committing a change, make sure task still works
dependencyUpdates {
  def isNonStable = { String version ->
    def stableKeyword = ['RELEASE', 'FINAL', 'GA'].any { qualifier -> version.toUpperCase().contains(qualifier) }
    def regex = /^[0-9,.v-]+$/
    return !stableKeyword && !(version ==~ regex)
  }
  rejectVersionIf { selection -> // <---- notice how the closure argument is named
    return isNonStable(selection.candidate.version) && !isNonStable(selection.currentVersion)
  }
}



// https://jeremylong.github.io/DependencyCheck/dependency-check-gradle/configuration.html
dependencyCheck {
  // Specifies if the build should be failed if a CVSS score above a specified level is identified.
  // range of 0-10 fails the build, anything greater and it doesn't fail the build
  failBuildOnCVSS = 0
  suppressionFile = 'config/owasp/suppressions.xml'

  analyzers {
    // Disable scanning of .NET related binaries
    assemblyEnabled = false
  }
  skipConfigurations = [
    "checkstyle",
    "compileOnly",
    "functionalTest",
    "smokeTest",
    "pmd"
  ]
}

checkstyle {
  maxWarnings = 0
  toolVersion = '10.17.0'
  getConfigDirectory().set(new File(rootDir, 'config/checkstyle'))
}

pmd {
  toolVersion = "6.55.0"
  sourceSets = [sourceSets.main, sourceSets.test, sourceSets.smokeTest, sourceSets.functionalTest]
  reportsDir = file("$project.buildDir/reports/pmd")
  // https://github.com/pmd/pmd/issues/876
  ruleSets = []
  ruleSetFiles = files("config/pmd/ruleset.xml")
}

jacocoTestReport {
  executionData(test)
  reports {
    xml.required = true
    csv.required = false
    html.required = true
  }
}

project.tasks['sonarqube'].dependsOn jacocoTestReport

def exclusions = "**/src/main/java/uk/gov/hmcts/pdm/publicdisplay/manager/dto/**, **/src/main/java/uk/gov/hmcts/pdm/business/entities/**"
sonarqube {
  properties {
    property "sonar.projectName", "pdm"
    property "sonar.projectKey", "pdm-sonarqube"
    property "sonar.cpd.exclusions", exclusions

  }
}

repositories {
    mavenLocal()
    mavenCentral()
    maven {
        url = uri('https://jitpack.io')
    }
}

ext {
  log4JVersion = "2.23.1"
}

ext['snakeyaml.version'] = '2.0'

configurations {
    all*.exclude group: 'org.glassfish.hk2', module: 'hk2'
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-actuator:3.1.11'
    implementation 'org.springframework.boot:spring-boot-starter-web:3.1.11'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa:3.1.11'
    implementation 'org.springframework.data:spring-data-commons:3.1.11'
    implementation 'org.springframework.data:spring-data-jpa:3.1.11'
    // Comment out org.hibernate:hibernate-entitymanager to work in Eclipse
    implementation 'org.hibernate:hibernate-entitymanager:5.6.15.Final'
    implementation 'org.postgresql:postgresql:42.7.3'
    implementation 'org.springframework.security:spring-security-core:6.3.1'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity5:3.1.2.RELEASE'
    implementation ('org.apache.httpcomponents:httpclient:4.5.14') {
    exclude group: 'commons-logging', module: 'commons-logging'
  }
    implementation 'io.jsonwebtoken:jjwt:0.9.1'
    implementation 'org.springframework:spring-tx:6.0.19'
    implementation 'org.dbunit:dbunit:2.8.0'
    implementation 'joda-time:joda-time:2.12.7'
    implementation 'org.owasp:csrfguard:4.3.0'
    implementation 'org.springframework.security:spring-security-taglibs:6.3.1'
    implementation 'org.springframework.security:spring-security-web:6.3.1'
    implementation 'org.quartz-scheduler:quartz:2.5.0-rc1'
    implementation 'org.apache.cxf:cxf-spring-boot-starter-jaxrs:4.0.5'
    implementation 'com.github.hmcts.java-logging:logging:6.1.6'
    implementation group: 'org.apache.logging.log4j', name: 'log4j-api', version: log4JVersion
    implementation group: 'org.apache.logging.log4j', name: 'log4j-to-slf4j', version: log4JVersion
    implementation 'javax.servlet:servlet-api:3.0-alpha-1'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-joda:2.17.2'
    implementation 'org.springframework.boot:spring-boot-starter-jersey:3.2.1'
    implementation 'org.owasp.esapi:esapi:2.5.4.0'
    implementation 'org.jasypt:jasypt:1.9.3'
    implementation 'org.springframework:spring-context:6.0.19'
    implementation 'org.springframework:spring-context-support:6.0.19'
    implementation 'org.apache.tomcat.embed:tomcat-embed-jasper:10.1.28'
    implementation 'org.glassfish.web:jakarta.servlet.jsp.jstl:3.0.1'
    implementation 'jakarta.servlet.jsp.jstl:jakarta.servlet.jsp.jstl-api:3.0.0'
    implementation 'org.yaml:snakeyaml:2.2'
    implementation 'org.apache.tomcat.embed:tomcat-embed-core:10.1.28'
    implementation 'org.apache.tomcat.embed:tomcat-embed-websocket:10.1.28'
    implementation 'org.apache.xmlgraphics:batik-css:1.17'
    implementation 'com.mchange:c3p0:0.10.1'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.17.2'
    implementation 'org.htmlunit:neko-htmlunit:4.4.0'
    implementation 'ch.qos.logback:logback-core:1.4.14'
    implementation 'ch.qos.logback:logback-classic:1.4.14'
    implementation 'javax.validation:validation-api:2.0.1.Final'
    implementation 'org.springframework.boot:spring-boot-starter-security:3.1.11'
    implementation 'org.springframework.ldap:spring-ldap-core:3.2.6'
    implementation 'org.springframework.security:spring-security-ldap:6.3.1'
    implementation 'com.unboundid:unboundid-ldapsdk:7.0.1'
    implementation 'org.owasp.antisamy:antisamy:1.7.6'
    implementation 'com.azure.spring:spring-cloud-azure-starter-active-directory:5.15.0'
    implementation group: 'org.springframework.boot', name: 'spring-boot-starter-oauth2-client'
    testImplementation 'org.springframework.boot:spring-boot-starter-test:3.1.11'
    testImplementation 'org.easymock:easymock:5.4.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.3.1'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.10.3'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine'
    compileOnly 'org.springframework.boot:spring-boot-starter-tomcat:3.1.11'
    implementation group: 'io.rest-assured', name: 'rest-assured'
}

mainClassName = 'uk.gov.hmcts.PdmanagerSpringbootApplication'

bootJar {
  archiveFileName = "pdmanager-1.0.war"

  manifest {
    attributes('Implementation-Version': project.version.toString())
  }
}

configurations {
   smokeTestImplementation.extendsFrom testImplementation
   smokeTestRuntimeOnly.extendsFrom runtimeOnly
   functionalTestImplementation.extendsFrom testImplementation
   functionalTestRuntimeOnly.extendsFrom runtimeOnly
   all*.exclude group: 'org.glassfish.hk2', module: 'hk2'
   all*.exclude group: 'commons-logging', module: 'commons-logging'
 }

tasks.register('smoke', Test) {
  description = "Runs Smoke Tests"
  testClassesDirs = sourceSets.smokeTest.output.classesDirs
  classpath = sourceSets.smokeTest.runtimeClasspath
}

tasks.register('functional', Test) {
  description = "Runs functional tests"
  group = "Verification"
  testClassesDirs = sourceSets.functionalTest.output.classesDirs
  classpath = sourceSets.functionalTest.runtimeClasspath
}